#!/bin/bash
# Script alternativo para exportar dados via API do Supabase
# Usa Service Role Key (limitado - apenas dados, n√£o schema completo)

set -e

PROJECT_REF="cghzttbggklhuyqxzabq"
SUPABASE_URL="https://${PROJECT_REF}.supabase.co"
BACKUP_DIR="${BACKUP_DIR:-./backup}"

if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    echo "‚ùå SUPABASE_SERVICE_ROLE_KEY n√£o fornecida"
    echo ""
    echo "Como obter:"
    echo "  1. Acesse: https://supabase.com/dashboard"
    echo "  2. V√° em: Settings ‚Üí API"
    echo "  3. Copie a 'service_role' key (secret)"
    echo ""
    echo "Uso:"
    echo "  export SUPABASE_SERVICE_ROLE_KEY='sua_service_role_key'"
    echo "  ./scripts/exportar-via-api.sh"
    exit 1
fi

mkdir -p $BACKUP_DIR

echo "=== Exporta√ß√£o via API do Supabase ==="
echo "‚ö†Ô∏è  ATEN√á√ÉO: Este m√©todo √© limitado!"
echo "   - Exporta apenas dados das tabelas p√∫blicas"
echo "   - N√£o exporta schema completo"
echo "   - N√£o exporta fun√ß√µes, triggers, etc."
echo ""
echo "Para exporta√ß√£o completa, use pg_dump com senha do PostgreSQL."
echo ""

# Listar tabelas via API
echo "1. Listando tabelas p√∫blicas..."

TABLES=$(curl -s "${SUPABASE_URL}/rest/v1/" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
  2>/dev/null | jq -r 'keys[]' 2>/dev/null || echo "")

if [ -z "$TABLES" ]; then
    echo "   ‚ö†Ô∏è  N√£o foi poss√≠vel listar tabelas via API"
    echo "   Isso pode ser normal - a API REST n√£o exp√µe metadados diretamente"
    echo ""
    echo "üìù Recomenda√ß√£o: Use pg_dump com senha do PostgreSQL"
    echo "   Ver: COMO_OBTER_SENHA_POSTGRESQL.md"
    exit 1
fi

echo "   Tabelas encontradas:"
echo "$TABLES" | while read table; do
    echo "     - $table"
done

echo ""
echo "‚ö†Ô∏è  Exporta√ß√£o via API requer conhecimento das tabelas."
echo "   Este script √© apenas uma base - voc√™ precisar√° adaptar."
echo ""
echo "üìù Para exporta√ß√£o completa, use:"
echo "   export SUPABASE_PASSWORD='senha_postgresql'"
echo "   ./scripts/exportar-supabase-completo.sh"
